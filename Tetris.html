<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Tetris</title>

    <style>

        body{
            margin: 16px;
            background-color: black;
        }

        .main-container{
            /*placeholder*/
        }
    
        .main-division{
            border: 1px solid red;
        }

        #board{
            display: grid;
            margin: auto;
        }
    
    </style>

</head>
<body>
    <div id="" class="main-container">

        <div id="board" class="main-division"></div>

    </div>

    <script>
    
        // variables for catching html elements
        let board = document.getElementById('board');

        // board grid - number of rows and columns
        let boardHeight = 20;
        let boardWidth = 10;

        // set board width and height in pixels
        let buildingBlockSize = 30;
        board.style.width = buildingBlockSize * boardWidth + "px";
        board.style.height = buildingBlockSize * boardHeight + "px";

        // global variables for game mechanics
        let boardMatrix = [];
        let activeTet;
        let direction;
        let blocks = [[],[],[],[]];
        let blockIndex;

        // set-up the grid inside the board
        board.style.gridTemplateColumns = "repeat(" + boardWidth + ", 1fr)";

        // creation of board elements for display of tetrominos
        for (let i = 0; i < boardHeight; i++) {
            for (let j = 0; j < boardWidth; j++) {
                let temp = document.createElement("div");
                temp.setAttribute('id', 'q-' + i + '-' + j);
                board.appendChild(temp);
            }
        }

        // initialize board matrix (here is where we store the fixed pieces later)
        for (let i = 0; i < boardHeight + 1; i++) {

            boardMatrix[i] = [];

            for (let j = 0; j < boardWidth; j++) {
                // if (i == boardHeight) {
                // boardMatrix [i][j] = 'x';
                // }
                // else {
                boardMatrix[i][j] = 0;
                //}
            }
        }

        let tetrominoColor = [

            "red",
            "blue",
            "yellow",
            "orange",
            "green",
            "purple",
            "white"
        ];

        let tetrominoType = [

            [
                [0, 1, 1],
                [1, 1, 0],
                [0, 0, 0]
            ],
            [
                [1, 1, 0],
                [0, 1, 1],
                [0, 0, 0]
            ],
            [
                [0, 1, 0],
                [1, 1, 1],
                [0, 0, 0]
            ],
            [
                [1, 0, 0],
                [1, 1, 1],
                [0, 0, 0]
            ],
            [
                [0, 0, 1],
                [1, 1, 1],
                [0, 0, 0]
            ],
            [
                [1, 1],
                [1, 1],
            ],
            [
                [0, 0, 0, 0],
                [1, 1, 1, 1],
                [0, 0, 0, 0],
                [0, 0, 0, 0]
            ],
        ]

        // define class Tetromino
        class Tetromino {
            constructor(type, color, xCoord, yCoord, orient) {
                this.type = type;
                this.color = color;
                this.xCoord = xCoord;
                this.yCoord = yCoord;
                this.orient = orient;
            }

            // draw a given tetromino piece inside the board in the given coordinates
            draw() {
                
                blockIndex = 0;
                let temp = this.type;
                console.log(temp);
                for (let i = 0; i < temp.length; i++) {
                    for (let j = 0; j < temp.length; j++) {
                        if (temp[i][j] == 1) {
                            document.getElementById('q-' + (i + this.xCoord) + '-' + (j + this.yCoord)).style.backgroundColor = this.color;
                            blocks[blockIndex] = [i + this.xCoord, j + this.yCoord];
                            blockIndex++;
                        }
                    }
                }
                console.log(blocks);
            }

            erase() {

                    let temp = this.type;
                    for (let i = 0; i < temp.length; i++) {
                        for (let j = 0; j < temp.length; j++) {
                            if (temp[i][j] == 1) {
                                document.getElementById('q-' + (i + this.xCoord) + '-' + (j + this.yCoord)).style.backgroundColor = "";
                            }
                        }
                    }
                    blocks = [[],[],[],[]];
            }

            moveDown() {
                // if (this.type.length == 4) {
                //     if (this.orient == 0 && this.xCoord == boardHeight - this.type.length + 2) {
                //         this.xCoord -= 1;
                //     }
                //     if (this.orient == 2 && this.xCoord == boardHeight - this.type.length + 1) {
                //         this.xCoord -= 1;
                //     }
                //     if ((this.orient == 1 && this.xCoord == boardHeight - this.type.length) ||
                //         (this.orient == 3 && this.xCoord == boardHeight - this.type.length)) {
                //         this.xCoord -= 1;
                //     }
                // }
                // else if (this.type.length == 2) {
                //     if (this.xCoord == boardHeight - this.type.length) {
                //         this.erase();
                //         this.xCoord -= 1;
                //         this.draw();
                //     }
                // }
                // else {
                //     if (this.orient == 0 && this.xCoord == boardHeight - this.type.length + 1) {
                //         this.xCoord -= 1;
                //     }
                //     if (this.orient != 0 && this.xCoord == boardHeight - this.type.length) {
                //         console.log("landed!");
                //         this.xCoord -= 1;
                //         // fix active piece to board matrix here and create new active piece
                //         //fixTetrominoToBoard(this.type, this.xCoord, this.yCoord);
                //         // create new tetromino
                //         createNew();
                //     }
                // }
                // direction = "down";
                // checkCollision(this, direction);
                this.erase();
                this.xCoord += 1;
                this.draw();
            }

            moveLeft() {

                // if (this.type.length == 4) {
                //     if ((this.orient == 1) && this.yCoord == -2) {
                //         this.yCoord += 1;
                //     }
                //     if ((this.orient == 3) && this.yCoord == -1) {
                //         this.yCoord += 1;
                //     }
                //     if (this.orient % 2 == 0 && this.yCoord == 0) {
                //         this.yCoord += 1;
                //     }
                // }
                // else {
                //     if (this.orient == 1 && this.yCoord == -1) {
                //         this.yCoord += 1;
                //     }
                //     if (this.orient != 1 && this.yCoord == 0) {
                //         this.yCoord += 1;
                //     }
                // }
                // direction = "left";
                // checkCollision(this, direction);
                this.erase();
                this.yCoord -= 1;
                this.draw();
            }

            moveRight() {

                // if (this.type.length == 4) {
                //     if ((this.orient == 1) && this.yCoord == boardWidth - this.type.length + 1) {
                //         this.yCoord -= 1;
                //     }
                //     if ((this.orient == 3) && this.yCoord == boardWidth - this.type.length + 2) {
                //         this.yCoord -= 1;
                //     }
                //     if (this.orient % 2 == 0 && this.yCoord == boardWidth - this.type.length) {
                //         this.yCoord -= 1;
                //     }
                // }
                // else {
                //     if (this.orient == 3 && (this.yCoord == boardWidth - this.type.length + 1)) {
                //     this.yCoord -= 1;
                //     }
                //     if ((this.orient != 3) && this.yCoord == boardWidth - this.type.length) {
                //         this.yCoord -= 1;
                //     }
                // }
                // direction = "right";
                // checkCollision(this, direction);
                this.erase();
                this.yCoord += 1;
                this.draw();


            }

            rotate() {



                // if (this.type.length == 4) {
                //     if ((this.orient == 0 || this.orient == 2) && (this.xCoord == boardHeight - this.type.length + 1)) {
                //         this.erase();
                //         this.xCoord -= 1;
                //         this.draw();
                //     }
                //     else if ((this.orient == 0 || this.orient == 2) && (this.xCoord == boardHeight - this.type.length + 2)) {
                //         this.erase();
                //         this.xCoord -= 2;
                //         this.draw();
                //     }
                //     else if ((this.orient == 1 && this.yCoord == boardWidth - this.type.length + 1) ||
                //         (this.orient == 3 && this.yCoord == boardWidth - this.type.length + 1)) {
                //         this.moveLeft();
                //     }
                //     else if (this.orient == 3 && this.yCoord == boardWidth - this.type.length + 2) {
                //         this.moveLeft();
                //         this.moveLeft();
                //     }
                //     else if (this.orient == 1 && this.yCoord == -2) {
                //         this.moveRight();
                //         this.moveRight();
                //     }
                //     else if ((this.orient == 1 && this.yCoord == -1) ||
                //             (this.orient == 3 && this.yCoord == -1)) {
                //         this.moveRight();
                //     }
                // }
                // else {
                //     if (this.orient == 3) {
                //         this.moveLeft();
                //     }
                //     else if (this.orient == 0 && this.xCoord == boardHeight - this.type.length + 1) {
                //         this.erase();
                //         this.xCoord -= 1;
                //     }
                //     else if (this.orient == 1) {
                //         this.moveRight();
                //     }
                // }
                // else if (this.orient == 2 && this.xCoord == 18) {
                //     //return;
                //     this.moveUp();
                // }

                let temp = this.type;
                let temp2 = [];
                for (let i = 0; i < this.type.length; i++) {
                    temp2[i] = [];
                    for (let j = 0; j < this.type.length; j++) {
                        temp2[i][j] = temp[this.type.length - 1 - j][i];    
                    }
                    
                }
                if (this.type.length != 2) {

                    this.erase();
                    this.type = temp2;
                    this.draw();

                    this.orient++;
                    if (this.orient == 4) {
                        this.orient = 0;
                    }
                }               
                console.log("orientation: " + this.orient);
            }

            // collisionDetection() {
            //     if (this.yCoord == 0) {
            //         return true;
            //     }
            //     return false;
            // }
        }

        function checkCollision(piece, direction) {

            // if (blocks[0] == blocks[1]) {
            //     console.log("Fuck they are equal!!!!! :(");
            // }

            for (let i = piece.type.length - 1; i >= 0; i--) {
                for (let j = piece.type.length - 1; j >= 0; j--) {
                    
                    console.log("attempting block " + (i + piece.xCoord) + ", " + (j + piece.yCoord));
                    let temp = document.getElementById('q-' + (i + piece.xCoord) + '-' + (j + piece.yCoord));
                    if (temp.style.backgroundColor != "") {
                        if (document.getElementById('q-' + (i + piece.xCoord + 1) + '-' + (j + piece.yCoord)).style.backgroundColor != "") {
                            for (let k = 0; k < blocks.length; k++) {
                                    console.log("about to compare [" + blocks[k][0] + ", " + blocks[k][1] + "]");
                                    console.log("to [" + (i + piece.xCoord + 1) + ", " + (j + piece.yCoord) + "]");
                                if ((blocks[k][0] == (i + piece.xCoord + 1)) && (blocks[k][1] == (j + piece.yCoord))) {
                                    // console.log("compared " + blocks[k][0] + " and " + (i + piece.xCoord + 1));
                                    // console.log("compared " + blocks[k][1] + " and " + (j + piece.yCoord + 1));
                                    continue;
                                }
                            }
                            console.log("collision detected!!!");
                            return true;
                        }
                    }
                    
                }
                
            }

            console.log("NO collision");
            return false;

            // for (let i = boardHeight - 1; i >= 0; i--) {
            //     for (let j = boardWidth - 1; j >= 0; j--) {
                    
            //         let temp = document.getElementById('q-' + i + '-' + j);
                    
            //         if (temp.style.backgroundColor != "") {
            //             if (document.getElementById('q-' + (i + 1) + '-' + j).style.backgroundColor != "") {
            //                 for (let k = 0; k < blocks.length; k++) {
            //                     if (blocks[k][0] == i + 1 && blocks[k][1] == j) {

            //                         return true;
            //                     }
                                
            //                 }
            //             }
            //         }
                    
            //     }
                
            // }


            // from moveDown()
            if (direction == "down") {
                

            }

            // from moveLeft()
            if (direction == "left") {
                

            }

            // from moveRight()
            if (direction == "right") {

            }

            // from rotate()

        }

        function fixTetrominoToBoard(type, x, y) {
            console.log("Xcoord: " + x + ", Ycoord: " + y);

            let k = 0, l = 0;
            //let m = 0, n = 0;
            //let o = 0; p = 0;
            for (let i = 0; i < boardHeight; i++) {
                console.log("fix-outerForLoop");
                for (let j = 0; j < boardWidth; j++) {
                    console.log("fix-innerForLoop");







                // if (i >= x && j >= y) {
                //     boardMatrix[i][j] = type[k][l];
                //     k++;
                // }
                // if (k == type.length) {
                //     k = 0;
                // }


                    
                //     if (i >= x && j >= y) {
                //         console.log("fix-ifStatement");
                //         if (type[k][l] != 0) {
                //             boardMatrix[i][j] = 1;
                //             console.log("(k: " + k + ", l: " + l + ")");
                //         }
                //         k++;
                //         if (k == type.length) {
                //             k = 0;
                //         }
                //     }
                }
                // l++;
                // if (l == type.length) {
                //     l = 0;
                // }
            }
        }

        document.addEventListener('keydown', function (e) {
            //console.log(e.keyCode);
            if (e.keyCode == 87) {
                // user pressed 'w' for up
                direction = "rot";
                if (!(checkCollision(activeTet, direction))) {

                    activeTet.rotate();
                }
            }
            if (e.keyCode == 68) {
                // user pressed 'd' for right
                direction = "right";
                if (!(checkCollision(activeTet, direction))) {
                    activeTet.moveRight();
                }
            }
            if (e.keyCode == 83) {
                // user pressed "s" for down
                direction = "down";
                if (!(checkCollision(activeTet, direction))) {
                    activeTet.moveDown();
                }
            }
            if (e.keyCode == 65) {
                // user pressed 'a' for left
                direction = "left";
                if (!(checkCollision(activeTet, direction))) {
                    activeTet.moveLeft();
                }
            }
            console.log(boardMatrix);
            console.log(activeTet.xCoord + ", " + activeTet.yCoord);
        });

        function createNew() {            
            let selectedPiece = 4;
            activeTet = new Tetromino(tetrominoType[selectedPiece], tetrominoColor[selectedPiece], 0, 0, 0);
            activeTet.draw();
        }

        createNew();
    
    </script>
</body>
</html>
